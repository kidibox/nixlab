---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/source.toolkit.fluxcd.io/gitrepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: openebs-zfs-localpv
  namespace: flux-system
spec:
  interval: 30m0s
  url: https://github.com/openebs/zfs-localpv
  ref:
    tag: v2.3.0
---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/kustomize.toolkit.fluxcd.io/kustomization_v1.json
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: zfs-localpv
  namespace: flux-system
spec:
  interval: 30m0s
  path: ./deploy/yamls
  prune: true
  retryInterval: 2m0s
  sourceRef:
    kind: GitRepository
    name: openebs-zfs-localpv
  timeout: 3m0s
  wait: true
  patches:
    - patch: |-
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: openebs-zfspv-bin
          namespace: kube-system
        data:
          zfs: |
            #!/bin/sh
            if [ -x /host/sbin/zfs ]; then
              chroot /host /sbin/zfs "$@"
            elif [ -x /host/usr/sbin/zfs ]; then
              chroot /host /usr/sbin/zfs "$@"
            elif [ /host/run/current-system ]; then
              chroot /host /run/current-system/sw/bin/zfs "$@"
            else
              chroot /host zfs "$@"
            fi
